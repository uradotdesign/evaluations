<!-- polyfill needed for IE11 and below -->
<script type="text/javascript" src={{ "js/object-assign.js" | absURL }}></script>
<!-- Printing and PDF exports -->

<script src="{{ printf "js/reveal.js" | absURL }}"></script>

<!-- load default and user plugins -->
{{- $plugins := partial "internal/plugins" . -}}
{{ $pluginNames := slice }}

{{- range $plugins }}
  <script type="text/javascript" src="{{ .source | absURL }}"></script>
  {{ $pluginNames = $pluginNames | append .name }}
{{- end -}}

<!-- initialize Reveal.js -->
<script type="text/javascript">
  function camelize(map) {
    if (map) {
      Object.keys(map).forEach(function(k) {
        newK = k.replace(/(\_\w)/g, function(m) { return m[1].toUpperCase() });
        if (newK != k) {
          map[newK] = map[k];
          delete map[k];
        }
      });
    }
    return map;
  }

  var revealHugoDefaults = { center: true, controls: true, history: true, progress: true, transition: "slide" };
  var revealHugoSiteParams = {{ jsonify (partial "internal/func/cleanParams" .Site.Params.reveal) | safeJS }};
  var revealHugoPageParams = {{ jsonify (partial "internal/func/cleanParams" .Page.Params.reveal) | safeJS }};

  var revealHugoPlugins = {
    plugins: {{ (printf "%s" (replace ( jsonify ( $pluginNames ) ) "\"" "")) | safeJS }}
  };

  var options = Object.assign({},
    camelize(revealHugoDefaults),
    camelize(revealHugoSiteParams),
    camelize(revealHugoPageParams),
    camelize(revealHugoPlugins)
  );

  Reveal.initialize(options);
</script>

<!-- Slideshow Settings -->
<script type="text/javascript" src="{{ "js/settings.js" | absURL }}"></script>

{{ $hasMermaid := false }}
{{ $hasMath := false }}
{{ range .Site.AllPages }}
  {{ if .Store.Get "hasMermaid" }}
    {{ $hasMermaid = true }}
  {{ end }}
  {{ if or .Params.math (.Store.Get "hasMath")  }}
    {{ $hasMath = true }}
  {{ end }}
{{ end }}

{{ if $hasMermaid }}
<script type="text/javascript" src="{{ "js/mermaid.min.js" | absURL }}"></script>
<script type="text/javascript">
  mermaid.initialize({startOnLoad: false});
  let render = (event) => {
    let mermaidElems = event.currentSlide.querySelectorAll('.mermaid');
    if (!mermaidElems.length){
        return
    }
    mermaidElems.forEach(mermaidElem => {
        let processed = mermaidElem.getAttribute('data-processed');
        if (!processed){
            // https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344
            mermaid.init(undefined, mermaidElem);
        }
    });
  };
  // support current page reload with possible mermaid element
  render({currentSlide: Reveal.getCurrentSlide()});

  Reveal.on('slidechanged', render);
  Reveal.on('ready', render);
</script>
{{ end }}

{{ if $hasMath }}
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async src="{{ "js/tex-svg.js" | absURL }}"></script>
{{ end }}
